---
layout: post
title: "京喜图片框架优化过程"
date: 2021-03-31
categories: iOS
tags: [iOS]
---

# 背景
京喜APP经过前期1年快速原生化过程，在这期间我们也发现了一些图片相关的问题，包括体验问题和性能问题。经过初步排查存在以下问题：
### 图片加载慢/流量消耗高
图片链接主要由接口下发，下发图片`格式`和`尺寸`由每个业务后台自己把控。部分业务没有使用更小的图片格式比如`webp`，图片`尺寸`没有限制，都会导致部分页面图片加载慢。特别是网络不好的场景，给用户带来不好的体验。
### 图片内存占用高
经过初步的内存使用排查，图片内存消耗占APP总内存消耗的比例最高，特别是大尺寸图片会占用很多内存。一方面APP占用太高内存退到后台容易被系统杀死，导致下次打开重新启动影响体验。另一方面APP大量使用内存，容易被系统杀死产生`OOM`。特别是我们目前有大量的低端设备用户，设备内存相对比较低。

# 优化方向
作为电商APP，图片在各个业务场景被大量使用到。我们的优化方向是如何尽可能降低`网络消耗`/`内存消耗`，同时尽量不降低图片质量，给用户带来更好的使用体验。所以我们对图片框架进行了整体重构优化。

## 最小化图片网络加载
### 图片URL转换
京东图片服务器提供了多种处理功能，例如图片格式转换，图片降质，图片缩放，添加图片圆角等功能。所以我们在网络图片加载前，检测是否是`jd`域名的图片URL。如果`域名`匹配，图片框架先对图片`URL`进行预处理。
#### 域名处理
目前图片服务器提供了多个图片域名可使用，例如`m.360buyimg.com`，`img10.360buyimg.com`等多个域名。由于对接了多个业务后台，导致接口会下发不同的域名图片。存在以下问题：
- 不利于`缓存复用`，导致图片重复下载，同样的图片占用多份内存。(图片框架默认以`URL`作为图片`缓存key`)。
- 不利于`HTTP/2`连接复用。当加载多个图片时，每个域名都需要重新创建TCP连接，TLS握手过程。目前一次创建连接过程大概`50-150ms`。

优化方案：在预处理时，将图片URL`域名`替换成统一域名。通过此优化，减少了`10%+`的重复图片下载。同时减少之前`多域名`图片加载时重复创建HTTP请求的过程，减少图片加载时间。
#### 图片缩放
##### 动态scale
业务方使用图片API时传入对应显示大小的图片`size`，图片框架根据`scale`动态计算实际的像素`宽高`。
###### 其他
这里添加了一些额外的处理，对于超过一定尺寸的大图片，。
一方面是应为目前大部分图片
##### 异常保护
图片尺寸上限限制。正常情况下图片`宽/高`不应该超过屏幕`宽/高`。所以添加了一个限制图片尺寸为屏幕`宽/高`。

> 提示：`android`设备因为屏幕差异比较大，更适合使用固定的`scale`。同样的尺寸更有利于`CDN`缓存。
#### 降质
对于大部分业务场景，
#### 使用WebP格式
使用`webp`格式，减少图片大小。针对`png`/`jpg`图片格式，自动追加`webp`后缀，使图片服务器下发`webp`格式。由于目前图片服务器并不支持`gif`转`webp`，gif并没有做处理。
> 提示：`webp`相比`png`/`jpg`图片解码时间更长一些，但相对网络消耗还是值得。
#### URL转换缓存
添加一个轻量缓存，提高`URL`转换性能。因为`URL`转换本身有一定的耗时，单个图片`URL`可能会多次加载。转换后的`URL`会直接保存到缓存中，下次使用可以直接返回。缓存`key`由`URL`+相关图片转换参数拼接组成。

## 降低图片内存消耗
### 设置图片缓存上限
设置图片缓存上限，防止图片缓存占用太高内存。定义了一个默认的初始值上限，然后对于`3x`大屏幕用户和高端机器(内存比较高)，适当增加更多内存上限。
### 降低图片内存峰值
一张图片的内存消耗大概是`像素宽`x`像素高`x`4字节`，一张`500px-500px`的大概`1MB`内存。所以我们通过上面`URL`的过程让图片服务器下发更小的图片格式，已经降低了一部分内存。但是`URL`转换只处理了`jd`域名的`jpg`/`png`图片，对于`gif`或`jd`域名外的图片没有处理，包括一部分`URL`转换后加载失败的图片。所以对于这部分图片，我们会在端侧做图片缩放的处理，降低内存消耗。例如一张`300px-300px`包含`100帧`的gif图片，实际显示区域只有`50px-50px`，优化后可从`30MB+`内存降低到`3MB`。

## 优化成果
[![Objective-C]({{ '/resources/images/image_optim_result.png' | prepend: site.baseurl }})]

## 其他策略
### 加载异常处理
因为少数图片通过`URL`转换后，可能会存在图片不存在等异常场景。所以当发生加载失败时，我们还是需要加载原始图片。但是这里需要屏蔽一些特殊错误，避免非必要的加载。例如屏蔽无网络/网络超时/主动取消加载等错误。同时图片框架会将加载错误图片`URL`上报到后台，一方面后面调整`URL`转换策略，一方面可以发现一部分错误的图片`URL`。
### 线上配置
目前存在的一些功能，例如`URL`转换/统一域名/WebP使用等功能，我们都添加了线上配置，方便灰度/降级。一方面在出现问题时可以降级某些功能，当新功能上线时也可以灰度测试。
### 大图检测
一方面我们通过线上灰度检测的方式，当发现大图片时会进行上报，后续推动业务方进行优化。另一方面我们在日常测试阶段，会开启`Debug`检测工具，当检测到大图片时，通过`图片翻转`/`高亮背景颜色`的方式提醒业务开发同学进行优化。


## URL转换
### 转换规则
- 先剥离全部参数，重新拼接。因为后台下发URL参数格式不确定
### 分辨率计算
- 大图片检测，默认图片不能大于屏幕宽度
- 根据设备动态计算，大图片是使用2X。低端机使用2X。ipad使用1.5X
### 添加缓存
- 添加到异步处理

## Flutter
- 复用原生图片框架能力
- 复用图片硬盘缓存
- 图片内存缓存无法复用
- imageCache优化缓存
- 周期性清理liveImage

## 未来优化方向
### 缓存算法
- LRU/LFU/weak缓存哪种方法更好？
LFU不适用，没有重复图片
weak缓存列表复用会重复加载
- 页面的粒度来管理内存，页面退出时释放
### 图片服务器支持更好的格式
- webp，pnga替换gif
- heic
### 根据网络类型下发质量
- 造成重复下载
- 经过处理以后下发质量已经很低
- 对于服务端无法处理的场景可以考虑


# 一些建议
### 不要直接暴露第三方图片库给业务使用
目前移动端通常会使用一些优秀的开源图片库实现网络图片加载功能，例如`SDWebImage`/`Fresco`等。但是这些框架只是提供通用的网络图片加载能力，通常我们需要在上层定制或添加一些自己的业务扩展能力。所以直接暴露第三方库给业务使用会遇到以下问题：
- 不方便后续的更新和扩展功能，甚至更换到其他网络库。会涉及所有使用的业务方修改，更新成本很高。
- 通常业务只需要使用`加载`/`下载`图片功能，其他功能很少使用。暴露太多能力会导致有些功能不可控，例如图片缓存功能。如果由业务方自己控制，无法统一管理。


# 其他
### URL转换服务端处理的问题
- 涉及业务比较多，比较麻烦，不可控
- 前面UI改动时，需要后台支持太繁琐
- 服务端需要了解低端机，分辨率等概率，对于他们成本高
- 支持特定图片格式或其他特性，都需要业务方改造，成本太大
### Android
android屏幕差异大，更适合使用固定的scale