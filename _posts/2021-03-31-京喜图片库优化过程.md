---
layout: post
title: "京喜图片库优化过程"
date: 2021-03-31
categories: iOS
tags: [iOS]
---

## URL转换
### 降低网络消耗
- jfs
- q70
- webp
### 转换规则
- 判断是否是png/jpg
- 判断host是否匹配
- 先剥离全部参数，重新拼接。因为后台下发URL参数格式不确定
### 分辨率计算
- 大图片检测，默认图片不能大于屏幕宽度
- 根据设备动态计算，大图片是使用2X。低端机使用2X。ipad使用1.5X
### 添加缓存
- 避免缓存，提供转换效率
- cachekey获取通过各种参数+URL拼接
- 添加到异步处理
### 多域名转换为统一域名
- 更有利缓存复用
- HTTP/2复用
### 兜底策略
- 图片加载失败时时，加载原图。
- 屏蔽超时/无网络/SD Cancel等错误
- 相关功能线上配置开关，可降级/灰度
### 异常处理
- 大图片检测，默认图片不能大于屏幕宽度


### 内存
### 内存峰值
- 设置内存上限峰值
- 根据机型差异化设置
### 内存降低
- 设置imageSize，降低解码后图片尺寸
- gif优化

## 异常
- 大图片检测，开发阶段debug调试工具，图片旋转或添加背景颜色
- 线上大图片检测，手机大图片
- 线上图片加载失败收集，用于发现问题图片和调整转换规则

## Flutter
- 复用原生图片框架能力
- 复用图片硬盘缓存
- 图片内存缓存无法复用
- imageCache优化缓存
- 周期性清理liveImage

## 未来优化方向
### 缓存算法
- LRU/LFU/weak缓存哪种方法更好？
LFU不适用，没有重复图片
weak缓存列表复用会重复加载
- 页面的粒度来管理内存，页面退出时释放
### 图片服务器支持更好的格式
- webp，pnga替换gif
### Android
android屏幕差异大，更适合使用固定的scale