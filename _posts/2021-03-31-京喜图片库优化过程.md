---
layout: post
title: "京喜图片框架优化过程"
date: 2021-03-31
categories: iOS
tags: [iOS]
---

# 背景
京喜APP经过前期1年快速原生化过程，在这期间我们也发现了一些图片相关的问题，包括体验问题和性能问题。经过初步排查存在以下问题：
### 图片加载慢/流量消耗高
图片链接主要由接口下发，下发图片`格式`和`尺寸`由每个业务后台自己把控。部分业务没有使用更小的图片格式比如`webp`，图片`尺寸`没有限制，都会导致部分页面图片加载慢。特别是网络不好的场景，给用户带来不好的体验。
### 图片内存占用高
经过初步的内存使用排查，图片内存消耗占APP总内存消耗的比例最高，特别是大尺寸图片会占用很多内存。一方面APP占用太高内存退到后台容易被系统杀死。另一方面APP大量使用内存，容易被系统杀死产生OOM。特别是我们目前有大量的低端设备用户，设备内存相对比较低。

# 优化方向
作为电商APP，图片在各个业务场景被大量使用到。我们的优化方向是如何尽可能降低`网络消耗`/`内存消耗`，同时尽量不降低图片质量，给用户带来更好的使用体验。

## 降低网络消耗/提高加载速度
### 降低网络消耗
- 
### 降低内存消耗
-


## URL转换
### 降低网络消耗
- jfs
- q70
- webp
### 转换规则
- 判断是否是png/jpg
- 判断host是否匹配
- 先剥离全部参数，重新拼接。因为后台下发URL参数格式不确定
### 分辨率计算
- 大图片检测，默认图片不能大于屏幕宽度
- 根据设备动态计算，大图片是使用2X。低端机使用2X。ipad使用1.5X
### 添加缓存
- 避免缓存，提供转换效率
- cachekey获取通过各种参数+URL拼接
- 添加到异步处理
### 多域名转换为统一域名
- 更有利缓存复用
- HTTP/2复用
### 兜底策略
- 图片加载失败时时，加载原图。
- 屏蔽超时/无网络/SD Cancel等错误
- 相关功能线上配置开关，可降级/灰度
### 异常处理
- 大图片检测，默认图片不能大于屏幕宽度
### 域名处理
- key过滤域名

### 内存
### 内存峰值
- 设置内存上限峰值
- 根据机型差异化设置
### 内存降低
- 设置imageSize，降低解码后图片尺寸
- gif优化

## 图片
- 支持圆角

## 异常
- 大图片检测，开发阶段debug调试工具，图片旋转或添加背景颜色
- 线上大图片检测，手机大图片
- 线上图片加载失败收集，用于发现问题图片和调整转换规则

## Flutter
- 复用原生图片框架能力
- 复用图片硬盘缓存
- 图片内存缓存无法复用
- imageCache优化缓存
- 周期性清理liveImage

## 未来优化方向
### 缓存算法
- LRU/LFU/weak缓存哪种方法更好？
LFU不适用，没有重复图片
weak缓存列表复用会重复加载
- 页面的粒度来管理内存，页面退出时释放
### 图片服务器支持更好的格式
- webp，pnga替换gif
- heic
### 根据网络类型下发质量
- 造成重复下载
- 经过处理以后下发质量已经很低
- 对于服务端无法处理的场景可以考虑


# 一些建议
### 不要直接暴露第三方图片库给业务使用
目前移动端通常会使用一些优秀的开源图片库实现网络图片加载功能，例如`SDWebImage`/`Fresco`等。但是这些框架只是提供通用的网络图片加载能力，通常我们需要在上层定制或添加一些自己的业务扩展能力。所以直接暴露第三方库给业务使用会遇到以下问题：
- 不方便后续的更新和扩展功能，甚至更换到其他网络库。会涉及所有使用的业务方修改，更新成本很高。
- 通常业务只需要使用`加载`/`下载`图片功能，其他功能很少使用。暴露太多能力会导致有些功能不可控，例如图片缓存功能。如果由业务方自己控制，无法统一管理。


# 其他
### URL转换服务端处理的问题
- 涉及业务比较多，比较麻烦，不可控
- 前面UI改动时，需要后台支持太繁琐
- 服务端需要了解低端机，分辨率等概率，对于他们成本高
- 支持特定图片格式或其他特性，都需要业务方改造，成本太大
### Android
android屏幕差异大，更适合使用固定的scale